<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <style>
      body {
          background-color: #ffcdda;
      }
    </style>
    <title>Contato - Sweet Donut</title>
  </head>
  <body>
    <header class="bg-light p-3 shadow-sm">
      <div class="container d-flex justify-content-between align-items-center">
        <a href="index.html">
          <img src="./imagens/logo.png" alt="Logo Sweet Donut" class="logo" />
        </a>
        <nav>
          <ul class="nav">
            <li class="nav-item">
              <a class="nav-link text-dark" href="quemSomos.html">Quem Somos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark" href="produtos.html">Produtos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark" href="contato.html">Contato</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark" href="unidades.html">Unidades</a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link text-dark cart-icon"
                href="finalizarCompra.html"
              >
                🛒 Carrinho
                <span class="cart-badge" id="cart-total">0</span>
              </a>
            </li>
            <li class="nav-item auth-buttons">
              <div class="user-info" id="user-info" style="display: none;">
                <span id="user-name"></span>
              </div>
              <a class="nav-link" href="login.html" id="login-link">Entrar</a>
              <a class="nav-link" href="#" id="logout-link" style="display: none;">Sair</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <div class="container my-5">
      <h1 class="text-center">Entre em Contato Conosco</h1>
      <p class="text-center">
        Estamos aqui para ajudar! Preencha o formulário abaixo e responderemos o
        mais rápido possível.
      </p>

      <form id="contactForm">
        <div class="mb-3">
          <label for="name" class="form-label">Nome</label>
          <input type="text" class="form-control" id="name" required minlength="3" />
          <div class="invalid-feedback">Nome deve ter pelo menos 3 caracteres</div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">E-mail</label>
          <input type="email" class="form-control" id="email" required />
          <div class="invalid-feedback">Email inválido</div>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">Telefone</label>
          <input type="tel" class="form-control" id="phone" required placeholder="(XX) XXXXX-XXXX" />
          <div class="invalid-feedback">Formato inválido. Use (XX) XXXXX-XXXX</div>
        </div>
        <div class="mb-3">
          <label for="subject" class="form-label">Assunto</label>
          <input type="text" class="form-control" id="subject" required minlength="5" />
          <div class="invalid-feedback">Assunto deve ter pelo menos 5 caracteres</div>
        </div>
        <div class="mb-3">
          <label for="message" class="form-label">Mensagem</label>
          <textarea class="form-control" id="message" rows="4" required minlength="10"></textarea>
          <div class="invalid-feedback">Mensagem deve ter pelo menos 10 caracteres</div>
        </div>
        <button type="submit" class="btn btn-primary">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          Enviar Mensagem
        </button>
      </form>

      <div class="mt-5">
        <h2>Informações de Contato</h2>
        <p><strong>Telefone:</strong> (11) 1234-5678</p>
        <p><strong>E-mail:</strong> contato@sweetdonut.com</p>
        <p><strong>Endereço:</strong> Av. Paulista, 1234, Centro, SP</p>
      </div>

      <div class="mt-5">
        <h2>Nos Encontre Aqui</h2>
        <div
          class="embed-responsive"
          style="position: relative; padding-bottom: 56.25%; height: 0"
        >
          <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3651.9014445469325!2d-46.65142328402885!3d-23.562868984681794!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x94ce59a7e0b1e6b3%3A0x64b5362f5553cc4b!2sAv.%20Paulista%2C%201234%20-%20Bela%20Vista%2C%20S%C3%A3o%20Paulo%20-%20SP%2C%2000134-010!5e0!3m2!1spt-BR!2sbr!4v1635282927715!5m2!1spt-BR!2sbr"
            width="600"
            height="450"
            style="
              border: 0;
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
            "
            allowfullscreen=""
            loading="lazy"
          ></iframe>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-4">
      <div class="container text-center">
        <p>&copy; 2024 Sweet Donut. Todos os direitos reservados.</p>
        <p>
          Siga-nos:
          <a href="#" class="text-white mx-2">Instagram</a> |
          <a href="#" class="text-white mx-2">Facebook</a> |
          <a href="#" class="text-white mx-2">Twitter</a>
        </p>
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script>
      // Verificar status de autenticação
      async function checkAuth() {
        const token = localStorage.getItem('token');
        const loginLink = document.getElementById('login-link');
        const logoutLink = document.getElementById('logout-link');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');

        if (token) {
          try {
            // Decodificar o token para obter informações do usuário
            const response = await fetch('http://localhost:3000/api/user', {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (response.ok) {
              const userData = await response.json();
              userName.textContent = `Olá, ${userData.name}`;
              userInfo.style.display = 'flex';
              loginLink.style.display = 'none';
              logoutLink.style.display = 'block';
            } else {
              // Se o token for inválido, limpa o localStorage
              localStorage.removeItem('token');
              showLoginState();
            }
          } catch (error) {
            console.error('Erro ao verificar autenticação:', error);
            showLoginState();
          }
        } else {
          showLoginState();
        }
      }

      function showLoginState() {
        const loginLink = document.getElementById('login-link');
        const logoutLink = document.getElementById('logout-link');
        const userInfo = document.getElementById('user-info');
        
        loginLink.style.display = 'block';
        logoutLink.style.display = 'none';
        userInfo.style.display = 'none';
      }

      // Manipular logout
      document.getElementById('logout-link').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('token');
        window.location.href = 'index.html';
      });

      // Verificar status de autenticação ao carregar a página
      checkAuth();

      // Função para validar o formulário
      function validateForm() {
        const form = document.getElementById('contactForm');
        const inputs = form.querySelectorAll('input[required], textarea[required]');
        let isValid = true;

        inputs.forEach(input => {
          if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
          } else {
            input.classList.remove('is-invalid');
          }

          // Validação específica para cada campo
          if (input.id === 'name' && input.value.length < 3) {
            input.classList.add('is-invalid');
            isValid = false;
          }
          if (input.id === 'subject' && input.value.length < 5) {
            input.classList.add('is-invalid');
            isValid = false;
          }
          if (input.id === 'message' && input.value.length < 10) {
            input.classList.add('is-invalid');
            isValid = false;
          }
        });

        // Validar email
        const email = document.getElementById('email');
        const emailRegex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
        if (!emailRegex.test(email.value)) {
          email.classList.add('is-invalid');
          isValid = false;
        }

        // Validar telefone
        const phone = document.getElementById('phone');
        const phoneRegex = /^\(\d{2}\) \d{5}-\d{4}$/;
        if (!phoneRegex.test(phone.value)) {
          phone.classList.add('is-invalid');
          isValid = false;
        }

        return isValid;
      }

      // Adicionar máscara para telefone
      document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        
        if (value.length > 0) {
          if (value.length <= 2) {
            value = `(${value}`;
          } else if (value.length <= 7) {
            value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
          } else {
            value = `(${value.slice(0, 2)}) ${value.slice(2, 7)}-${value.slice(7)}`;
          }
        }
        
        e.target.value = value;
      });

      // Manipular envio do formulário de contato
      document.getElementById('contactForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!validateForm()) {
          return;
        }

        const submitButton = e.target.querySelector('button[type="submit"]');
        const spinner = submitButton.querySelector('.spinner-border');
        
        try {
          // Mostrar spinner
          submitButton.disabled = true;
          spinner.classList.remove('d-none');

          const formData = {
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            subject: document.getElementById('subject').value.trim(),
            message: document.getElementById('message').value.trim()
          };

          console.log('Enviando dados:', formData); // Debug log

          const response = await fetch('http://localhost:3000/api/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });

          const data = await response.json();
          console.log('Resposta do servidor:', data); // Debug log

          if (response.ok) {
            alert('Mensagem enviada com sucesso!');
            e.target.reset();
          } else {
            alert(data.message || 'Erro ao enviar mensagem. Tente novamente.');
          }
        } catch (error) {
          console.error('Erro ao enviar mensagem:', error);
          alert('Erro ao enviar mensagem. Tente novamente.');
        } finally {
          // Esconder spinner
          submitButton.disabled = false;
          spinner.classList.add('d-none');
        }
      });
    </script>
    <script src="js/chatbot.js"></script>
  </body>
</html>
